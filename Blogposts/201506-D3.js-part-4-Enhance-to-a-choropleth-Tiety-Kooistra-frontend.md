#D3.js part 4 of 9. Enhance to a choropleth
**Name:** Tiety Kooistra

**Category:** Frontend

**Date:** April 2015

----------------------------------------------------------------------
Lets transform our map to a choropleth, based upon the amount of arrests per 100.000 inhabitants per province. We will shade the map from green for a few arrest to red for a lot of arrests. To do that we first need to load the arrest data. For later use we now already load the data of a period of 15 years, from 1999 till 2013. To see the finished choropleth of this blogpost visit the [demo](http://tietyk.github.io/D3/Prototype/part4-9.html) on my [github page.](http://tietyk.github.io/D3/)

###Load the data
Like we did in the previous post we will load the data with the [d3.json](https://github.com/mbostock/d3/wiki/Requests#d3_json) request method. To keep all variable declarations together I added an empty *data* variable in the variable list. In the callback the data will be bound to the SVG. First we need to select all the path elements in the SVG. We will then give each path a new class attribute. With a range of classes we can give each province a color depended upon the amount of arrest locally in a given year. The class names will be generated by the quantify function we will make in the next paragraph. 

<pre lang="js">
d3.json("arrests.json", function(json){
  data = json;
  svg.selectAll("path")
    .attr("class", quantify)
});
</pre>

###Create the choropleth
The quantify function should generate a range of class names based on the range in the arrest data and give each province path a class based on the local arrests in a specific year. A quick scan of the data reveals that the lowest arrest rate is in Drenthe with 358 arrests in the year 2000. In 2006 in Flevoland the highest rate is found with 1646 arrests. Now we have a range to work with and base our classes on with the quantify function.

<pre lang="js">
function quantify(d) {
	var f = data[d.properties.OMSCHRIJVI][1];
	return "q" + Math.min(8, ~~((f-250) / 150)) + "-9";
}
</pre>

Lets break down the code of the quantify function. The function is called on each path in the SVG, so each province will get its own class defining its color. In the variable *f* we store the arrest data for a specific province in a year. The *d* argument represents the province and the index will correspond to a year, 2000 in this case.

It returns a class name in the format q0-9 till q8-9, where the first number is the index of the maximal possible 9 classes. The formula calculates which index should be given for the number of arrests. *Math.min* rounds the outcome down to a whole number, between 0 and maximal *8*. *150* is the range of arrests per index and with *f-250* we set the threshold to be 250 arrest. This means it will return 0 / q0-9 for all values lower then 400 arrests (250+150) and 1 / q1-9 for arrests between the values 400 and 549, etcetera.

I choose to use a range of 9 colors and therefore 9 classes with this project. A handy tool whit a lot of options to generate a color scheme for a map is [colorbrewer](http://colorbrewer2.org/). For this project I extracted the diverging 9-class RdYlGn color scheme. The CSS for the classes will then be:

<pre lang="css">
  .q0-9 { fill:#1a9850; }
  .q1-9 { fill:#66bd63; }
  .q2-9 { fill:#a6d96a; }
  .q3-9 { fill:#d9ef8b; }
  .q4-9 { fill:#ffffbf; }
  .q5-9 { fill:#fee08b; }
  .q6-9 { fill:#fdae61; }
  .q7-9 { fill:#f46d43; }
  .q8-9 { fill:#d73027; }
</pre>

To finish of and get the classes to work properly we need to remove the style attribute for the fill we added in the previous version of the code to the map variable.

*Possible improvements*  
At the moment we load the data in the JSON format, but a lot of data is available in other formats like CSV or TSV. For now I needed to format the original CSV data manually to get it into a JSON format that is suitable to use in this setup. D3 also has loaders for the [CSV](https://github.com/mbostock/d3/wiki/Requests#d3_csv) and [TSV](https://github.com/mbostock/d3/wiki/Requests#d3_tsv) format, but they have been buggy for me.

**We now have a really nice choropleth map of the provinces of The Netherlands with the arrests per 100.000 inhabitants. In the next post we'll add some zoom capability to the map. That would make it even nicer.**